<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-3FY82H0FVC"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-3FY82H0FVC');
    </script>
    
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7522766513341235" crossorigin="anonymous"></script>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:title" content="é£å‘æ—¥æŠ¥">
    <meta property="og:description" content="åŠ¨æ€å¸‚åœºåˆ†æ">
    <meta property="og:image" content="/preview.jpg">
    <title>é£å‘æ—¥æŠ¥ - åŠ¨æ€å¸‚åœºåˆ†æ</title>
    
    <!-- æ ¸å¿ƒè§£æåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        /* æ ·å¼ä¿æŒä¸å˜ */
    </style>
</head>
<body>
    <!-- HTML ç»“æ„ä¿æŒä¸å˜ -->
    
    <script>
        // ä¿®å¤ 1: ä½¿ç”¨æ–°ç‰ˆ marked API
        // å®Œå…¨ç§»é™¤ marked.use() å’Œè‡ªå®šä¹‰ renderer
        // ç›´æ¥åœ¨ parse æ—¶ä¼ å…¥é…ç½®
        
        // é…ç½® Mermaid
        mermaid.initialize({
            startOnLoad: false,
            theme: 'dark',
            themeVariables: {
                primaryColor: '#3498db',
                primaryTextColor: '#e0e0e0',
                primaryBorderColor: '#3498db',
                lineColor: '#b0b0b0',
                secondaryColor: '#2ecc71',
                tertiaryColor: '#121212'
            },
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            sequence: {
                useMaxWidth: true
            }
        });
        
        // åŠ è½½READMEå‡½æ•°
        async function loadReadme() {
            const container = document.getElementById('readme-container');
            const refreshBtn = document.getElementById('refresh-btn');
            
            try {
                refreshBtn.disabled = true;
                container.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>æ­£åœ¨åŠ è½½å¸‚åœºåˆ†ææŠ¥å‘Š...</p></div>';
                
                // ä¿®å¤ 2: ç§»é™¤ URL ä¸­çš„ç©ºæ ¼
                const timestamp = new Date().getTime();
                const urls = [
                    `https://raw.githubusercontent.com/uu5zn/rss/main/README.md?t=${timestamp}`,
                    `https://cdn.jsdelivr.net/gh/uu5zn/rss@main/README.md?t=${timestamp}`
                ];
                
                let data = null;
                let lastError = null;
                
                // å°è¯•å¤šä¸ªæº
                for (const url of urls) {
                    try {
                        const response = await fetch(url);
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        data = await response.text();
                        break;
                    } catch (err) {
                        lastError = err;
                        console.warn(`ä» ${url} åŠ è½½å¤±è´¥:`, err);
                        continue;
                    }
                }
                
                if (!data) {
                    throw lastError || new Error('æ‰€æœ‰æ•°æ®æºéƒ½å¤±è´¥äº†');
                }
                
                // ä¿®å¤ 3: æ·»åŠ ç±»å‹æ£€æŸ¥
                if (typeof data !== 'string') {
                    throw new Error(`è·å–çš„æ•°æ®æ ¼å¼é”™è¯¯: ${typeof data}`);
                }
                
                // ä¿®å¤ 4: ä½¿ç”¨æ–°ç‰ˆ marked APIï¼Œç›´æ¥ä¼ å…¥é€‰é¡¹
                const html = marked.parse(data, {
                    gfm: true,
                    breaks: true,
                    pedantic: false,
                    smartLists: true,
                    smartypants: true,
                    // ç§»é™¤å·²å¼ƒç”¨çš„ sanitize é€‰é¡¹
                });
                
                // ä½¿ç”¨ DOMPurify è¿›è¡Œæ¸…ç†
                const safeHtml = DOMPurify.sanitize(html, {
                    ADD_TAGS: ['iframe'],
                    ADD_ATTR: ['target', 'rel', 'class', 'id']
                });
                
                // æ¸²æŸ“å†…å®¹
                container.innerHTML = `<div class="markdown-content">${safeHtml}</div>`;
                
                // é«˜äº®ä»£ç å—
                container.querySelectorAll('pre code').forEach(block => {
                    hljs.highlightElement(block);
                });
                
                // æ¸²æŸ“Mermaidå›¾è¡¨
                const mermaidBlocks = container.querySelectorAll('.mermaid');
                if (mermaidBlocks.length > 0) {
                    // ä¿®å¤ 5: ä½¿ç”¨ async/await å¤„ç† mermaid.render
                    await Promise.all(Array.from(mermaidBlocks).map(async (block) => {
                        const graphDefinition = block.textContent.trim();
                        if (!graphDefinition) return;
                        
                        try {
                            const { svg } = await mermaid.render(
                                `mermaid-${Date.now()}-${Math.random()}`, 
                                graphDefinition
                            );
                            block.innerHTML = svg;
                        } catch (err) {
                            console.warn('Mermaid æ¸²æŸ“å¤±è´¥:', err);
                        }
                    }));
                }
                
                // æ›´æ–°æ—¶é—´æˆ³
                updateTimestamp();
                
            } catch (error) {
                console.error('åŠ è½½å¤±è´¥:', error);
                container.innerHTML = `
                    <div class="error-message">
                        <h3>ğŸ“¡ åŠ è½½å¤±è´¥</h3>
                        <p>æ— æ³•è·å–æœ€æ–°çš„å¸‚åœºåˆ†ææŠ¥å‘Š: ${error.message}</p>
                        <p style="margin-top: 10px; font-size: 0.9rem;">è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•ã€‚</p>
                        <button class="retry-btn" onclick="loadReadme()">é‡æ–°åŠ è½½</button>
                    </div>
                `;
            } finally {
                refreshBtn.disabled = false;
            }
        }
        
        // æ›´æ–°æ—¶é—´æˆ³
        function updateTimestamp() {
            const now = new Date();
            const timeString = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('last-update').textContent = `æœ€åæ›´æ–°: ${timeString}`;
        }
        
        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œä¸€æ¬¡
        window.addEventListener('DOMContentLoaded', loadReadme);
    </script>
</body>
</html>
